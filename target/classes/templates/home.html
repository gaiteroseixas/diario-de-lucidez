<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Meu Fich√°rio de Sonhos</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="fichario-wrapper">
    
    <div class="header-status">
        <p>Ol√°, <span class="user-highlight" th:text="${nomeUsuario}">Edmur</span>, seja bem-vindo!</p>
    </div>

    <nav class="fichario-tabs">
        <button class="tab-btn active" onclick="openTab(event, 'inicio')">In√≠cio</button>
        <button class="tab-btn" onclick="openTab(event, 'historico')">Hist√≥rico</button>
        <button class="tab-btn" onclick="openTab(event, 'analise')">An√°lise</button>
        <a th:href="@{/logout}" class="tab-exit">Sair</a>
    </nav>

    <div id="inicio" class="tab-content show">
        <h1>Nova Jornada On√≠rica</h1>
        
        <form th:action="@{/salvar-sonho}" method="post" id="dreamForm" onsubmit="prepareSubmit()">
    
    <input type="hidden" name="id" id="dreamId" th:value="${sonhoParaEditar?.id}">
                  
    <div class="form-row" style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
        
        <div style="flex: 0 0 auto;">
            <input type="date" name="dataRegistro" id="dataSonho" required th:value="${sonhoParaEditar?.dataRegistro}" 
       style="padding: 10px 15px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.5); color: #03e9f4; border-radius: 8px; outline: none; font-family: inherit; font-weight: bold; cursor: pointer;">
        </div>

        <div style="flex: 1;">
            <input type="text" name="titulo" id="titulo" placeholder="D√™ um nome √† sua jornada.." class="input-title" required th:value="${sonhoParaEditar?.titulo}" style="width: 100%; box-sizing: border-box; margin: 0;">
        </div>
        
    </div>

    <div class="editor-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; padding: 10px; background: rgba(28, 42, 63, 0.8); border-radius: 8px; border: 1px solid rgba(3, 233, 244, 0.3); align-items: center;">
        <button type="button" onclick="formatarTexto('bold')" title="Negrito" style="background: rgba(255,255,255,0.05); color: #cbd5e0; border: 1px solid transparent; border-radius: 4px; width: 32px; height: 32px; cursor: pointer; font-weight: bold; transition: 0.3s;" onmouseover="this.style.background='rgba(3, 233, 244, 0.1)'; this.style.color='#03e9f4';" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.color='#cbd5e0';">B</button>
        <button type="button" onclick="formatarTexto('italic')" title="It√°lico" style="background: rgba(255,255,255,0.05); color: #cbd5e0; border: 1px solid transparent; border-radius: 4px; width: 32px; height: 32px; cursor: pointer; font-style: italic; transition: 0.3s;" onmouseover="this.style.background='rgba(3, 233, 244, 0.1)'; this.style.color='#03e9f4';" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.color='#cbd5e0';">I</button>
        <button type="button" onclick="formatarTexto('underline')" title="Sublinhado" style="background: rgba(255,255,255,0.05); color: #cbd5e0; border: 1px solid transparent; border-radius: 4px; width: 32px; height: 32px; cursor: pointer; text-decoration: underline; transition: 0.3s;" onmouseover="this.style.background='rgba(3, 233, 244, 0.1)'; this.style.color='#03e9f4';" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.color='#cbd5e0';">U</button>
        <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.1); margin: 0 5px;"></div>
        <button type="button" onclick="formatarTexto('insertUnorderedList')" title="Lista com Marcadores" style="background: rgba(255,255,255,0.05); color: #cbd5e0; border: 1px solid transparent; border-radius: 4px; padding: 0 10px; height: 32px; cursor: pointer; transition: 0.3s;" onmouseover="this.style.background='rgba(3, 233, 244, 0.1)'; this.style.color='#03e9f4';" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.color='#cbd5e0';">‚Ä¢ Lista</button>
        <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.1); margin: 0 5px;"></div>
        <div style="display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 4px;">
            <label style="color: #8a9fb5; font-size: 0.85em;">Cor do Texto:</label>
            <input type="color" onchange="mudarCor(this.value, 'foreColor')" title="Escolher cor da letra" style="border: none; background: transparent; cursor: pointer; height: 26px; width: 26px; padding: 0;">
        </div>
        <div style="display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 4px;">
            <label style="color: #8a9fb5; font-size: 0.85em;">Fundo:</label>
            <input type="color" onchange="mudarCor(this.value, 'hiliteColor')" title="Escolher cor de fundo do texto" style="border: none; background: transparent; cursor: pointer; height: 26px; width: 26px; padding: 0;">
        </div>
    </div>

    <div id="editor" contenteditable="true" class="dream-editor" th:utext="${sonhoParaEditar?.relato}"></div>
    <input type="hidden" name="relato" id="relatoInput" th:value="${sonhoParaEditar?.relato}">
                       
    <div class="lucidez-section" style="margin: 20px 0 30px 0; padding: 15px 20px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 4px solid #03e9f4; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
        <div>
            <label for="lucidez" style="color: #03e9f4; font-weight: bold; font-size: 1.1em; margin-bottom: 5px; display: block;">‚ú® N√≠vel de Lucidez</label>
            <p style="color: #8a9fb5; font-size: 0.85em; margin: 0;">Classifique seu grau de consci√™ncia durante o sonho.</p>
        </div>
        <div>
            <select name="lucidez" id="lucidez" th:value="${sonhoParaEditar?.lucidez}" style="padding: 10px 15px; border-radius: 8px; border: 1px solid rgba(3, 233, 244, 0.5); background: rgba(28, 42, 63, 0.8); color: #03e9f4; font-weight: bold; font-size: 1em; outline: none; box-shadow: 0 0 10px rgba(3, 233, 244, 0.1); cursor: pointer; appearance: auto;">
                <option value="0" style="background: #1c2a3f; color: white;" th:selected="${sonhoParaEditar?.lucidez == 0}">N√£o L√∫cido (0)</option>
                <option value="1" style="background: #1c2a3f; color: white;" th:selected="${sonhoParaEditar?.lucidez == 1}">N√≠vel 1 (Leve suspeita)</option>
                <option value="2" style="background: #1c2a3f; color: white;" th:selected="${sonhoParaEditar?.lucidez == 2}">N√≠vel 2 (Consci√™ncia clara)</option>
                <option value="3" style="background: #1c2a3f; color: white;" th:selected="${sonhoParaEditar?.lucidez == 3}">N√≠vel 3 (Controle total)</option>
            </select>
        </div>
    </div>

    <div style="background: rgba(185, 66, 245, 0.1); border-left: 4px solid #b942f5; padding: 12px 15px; margin-bottom: 25px; border-radius: 0 8px 8px 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.2em;">üí°</span>
        <p style="color: #cbd5e0; font-size: 0.9em; margin: 0; line-height: 1.4;">
            <strong style="color: #b942f5;">Dica para o Painel de An√°lise:</strong> 
            Para que suas estat√≠sticas funcionem perfeitamente, separe os diferentes elementos usando v√≠rgulas. <br>
            <em style="color: #8a9fb5;">Exemplo: cachorro, rel√≥gio derretido, voar, medo</em>
        </p>
    </div>

    <div class="category-section" style="margin-bottom: 30px; padding: 20px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; border: 1px dashed rgba(3, 233, 244, 0.3);">
        <h3 style="color: #03e9f4; margin-top: 0; border-bottom: 1px solid rgba(3, 233, 244, 0.2); padding-bottom: 10px;">üìä Categoriza√ß√£o B√°sica</h3>
        <div class="basic-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px;">
            <div class="category-item">
                <label style="color: #03e9f4; font-weight: bold; display: block; margin-bottom: 5px;">üë• Personagens</label>
                <input type="text" name="personagens" placeholder="Ex: Pai, Amigo" style="width: 100%; padding: 10px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.3); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.personagens}">
            </div>
            <div class="category-item">
                <label style="color: #03e9f4; font-weight: bold; display: block; margin-bottom: 5px;">üìç Lugares</label>
                <input type="text" name="lugares" placeholder="Ex: Casa antiga" style="width: 100%; padding: 10px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.3); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.lugares}">
            </div>
            <div class="category-item">
                <label style="color: #03e9f4; font-weight: bold; display: block; margin-bottom: 5px;">‚ú® Objetos</label>
                <input type="text" name="simbolos" placeholder="Ex: Chave, Carro" style="width: 100%; padding: 10px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.3); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.simbolos}">
            </div>
        </div>
    </div>

    <div class="category-section advanced" style="margin-bottom: 30px; padding: 20px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; border: 1px dashed rgba(3, 233, 244, 0.3);">
        <h3 style="color: #03e9f4; margin-top: 0; border-bottom: 1px solid rgba(3, 233, 244, 0.2); padding-bottom: 10px;">üî¨ Sistema LaBerge (Avan√ßado)</h3>
        <div class="laberge-form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
            
            <div class="laberge-group" style="display: flex; flex-direction: column; gap: 8px;">
                <h4 style="color: #8a9fb5; margin-bottom: 5px;">1. Consci√™ncia Interna</h4>
                <input type="text" name="pensamentos" placeholder="Pensamentos" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.pensamentos}">
                <input type="text" name="emocoes" placeholder="Emo√ß√µes" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.emocoes}">
                <input type="text" name="sensacoes" placeholder="Sensa√ß√µes" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.sensacoes}">
                <input type="text" name="percepcoes" placeholder="Percep√ß√µes" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.percepcoes}">
            </div>
            
            <div class="laberge-group" style="display: flex; flex-direction: column; gap: 8px;">
                <h4 style="color: #8a9fb5; margin-bottom: 5px;">2. A√ß√£o</h4>
                <input type="text" name="acaoEgo" placeholder="Sua A√ß√£o" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.acaoEgo}">
                <input type="text" name="acaoPersonagem" placeholder="A√ß√£o Personagem" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.acaoPersonagem}">
                <input type="text" name="acaoObjeto" placeholder="A√ß√£o Objeto" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.acaoObjeto}">
            </div>

            <div class="laberge-group" style="display: flex; flex-direction: column; gap: 8px;">
                <h4 style="color: #8a9fb5; margin-bottom: 5px;">3. Forma</h4>
                <input type="text" name="formaEgo" placeholder="Sua Forma" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.formaEgo}">
                <input type="text" name="formaPersonagem" placeholder="Forma Personagem" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.formaPersonagem}">
                <input type="text" name="formaObjeto" placeholder="Forma Objeto" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.formaObjeto}">
                <input type="text" name="formaCenario" placeholder="Forma Cen√°rio" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.formaCenario}">
            </div>

            <div class="laberge-group" style="display: flex; flex-direction: column; gap: 8px;">
                <h4 style="color: #8a9fb5; margin-bottom: 5px;">4. Contexto</h4>
                <input type="text" name="papelEgo" placeholder="Seu Papel" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.papelEgo}">
                <input type="text" name="lugarCenario" placeholder="Lugar Cen√°rio" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.lugarCenario}">
                <input type="text" name="tempoCenario" placeholder="Tempo Cen√°rio" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.tempoCenario}">
                <input type="text" name="situacaoBizarra" placeholder="Situa√ß√£o Bizarra" style="padding: 8px; background: rgba(28, 42, 63, 0.6); border: 1px solid rgba(3, 233, 244, 0.2); color: white; border-radius: 6px; outline: none;" th:value="${sonhoParaEditar?.situacaoBizarra}">
            </div>
            
        </div>
    </div>

    <div class="form-footer" style="margin-top: 30px;">
        <button type="submit" class="btn-save" style="padding: 12px 30px; background: #03e9f4; color: #1c2a3f; font-weight: bold; border-radius: 8px; border: none; cursor: pointer;">üíæ Salvar no Fich√°rio</button>
    </div>
    
</form>
</div> <div id="historico" class="tab-content">
    <h2 style="color: #03e9f4; margin-bottom: 20px;">Hist√≥rico de Sonhos</h2>
    
    <div th:if="${#maps.isEmpty(sonhosAgrupados)}" style="color: #8a9fb5; text-align: center; margin-top: 40px; font-size: 1.1em;">
        Nenhum sonho registrado ainda. A sua jornada come√ßa hoje! üåô
    </div>

    <div th:each="entry, iter : ${sonhosAgrupados}" style="margin-bottom: 15px;">
        
        <div class="laberge-summary" th:onclick="'toggleGaveta(\'data-' + ${iter.index} + '\')'" style="background: rgba(3, 233, 244, 0.08); border-color: rgba(3, 233, 244, 0.3);">
            <span style="font-size: 1.1em; color: white; font-weight: bold;">üìÖ <span th:text="${entry.value[0].dataFormatada}"></span></span>
            <span class="laberge-badge" style="background: #b942f5; color: white;" th:text="${#lists.size(entry.value)} + ' Sonho(s)'"></span>
        </div>

        <div th:id="'data-' + ${iter.index}" class="laberge-details" style="background: transparent; border: none; padding-right: 0; padding-bottom: 0;">
            
            <div th:each="sonho : ${entry.value}" style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #b942f5; position: relative;">
                
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px; margin-bottom: 15px;">
                    <span style="color: #ffcc00; font-weight: bold; font-size: 0.95em;">‚ú® Lucidez: N√≠vel <span th:text="${sonho.lucidez}"></span></span>
                    
                    <div style="display: flex; gap: 10px;">
                        <a th:href="@{/editar-sonho/{id}(id=${sonho.id})}" style="color: #03e9f4; text-decoration: none; font-size: 0.8em; border: 1px solid rgba(3, 233, 244, 0.4); padding: 5px 10px; border-radius: 4px; transition: 0.3s;" onmouseover="this.style.background='rgba(3, 233, 244, 0.1)'" onmouseout="this.style.background='transparent'">Editar</a>
                        
                        <a th:href="@{/excluir-sonho/{id}(id=${sonho.id})}" style="color: #ff4b2b; text-decoration: none; font-size: 0.8em; border: 1px solid rgba(255, 75, 43, 0.4); padding: 5px 10px; border-radius: 4px; transition: 0.3s;" onmouseover="this.style.background='rgba(255, 75, 43, 0.1)'" onmouseout="this.style.background='transparent'">Excluir</a>
                    </div>
                </div>
                
                <div style="color: #cbd5e0; line-height: 1.6; font-size: 1em; white-space: pre-wrap;" th:utext="${sonho.relato}"></div>
                
            </div>

        </div>
    </div>
</div>

<div id="analise" class="tab-content">
    <h2 style="color: #03e9f4; margin-bottom: 20px;">Painel de An√°lise On√≠rica</h2>
    
    <div class="stats-grid" style="display: flex; gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; flex: 1; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
            <span class="stat-value" style="display: block; font-size: 2em; color: #03e9f4;" th:text="${totalSonhos}">0</span>
            <span class="stat-label" style="color: #8a9fb5;">Total de Sonhos</span>
        </div>
        <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; flex: 1; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
            <span class="stat-value" style="display: block; font-size: 2em; color: #03e9f4;" th:text="${totalLucidos}">0</span>
            <span class="stat-label" style="color: #8a9fb5;">Sonhos L√∫cidos</span>
        </div>
    </div>

    <h3 style="color: #ffcc00; margin-bottom: 15px; border-left: 4px solid #ffcc00; padding-left: 10px;">üìä Categoriza√ß√£o B√°sica</h3>
    <div class="analysis-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px;">
        <div class="analysis-card" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-top: 3px solid #ffcc00;">
            <h3 style="color: white; font-size: 1.1em; margin-bottom: 10px;">üë• Personagens</h3>
            <table class="analysis-table" style="width: 100%; color: #cbd5e0;">
                <tr th:each="entry : ${cPers}">
                    <td class="item-name" th:text="${entry.key}"></td>
                    <td class="item-count" th:text="${entry.value}" style="text-align: right; color: #03e9f4;"></td>
                </tr>
            </table>
        </div>

        <div class="analysis-card" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-top: 3px solid #ffcc00;">
            <h3 style="color: white; font-size: 1.1em; margin-bottom: 10px;">üìç Lugares</h3>
            <table class="analysis-table" style="width: 100%; color: #cbd5e0;">
                <tr th:each="entry : ${cLug}">
                    <td class="item-name" th:text="${entry.key}"></td>
                    <td class="item-count" th:text="${entry.value}" style="text-align: right; color: #03e9f4;"></td>
                </tr>
            </table>
        </div>

        <div class="analysis-card" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-top: 3px solid #ffcc00;">
            <h3 style="color: white; font-size: 1.1em; margin-bottom: 10px;">‚ú® Objetos</h3>
            <table class="analysis-table" style="width: 100%; color: #cbd5e0;">
                <tr th:each="entry : ${cSimbolos}">
                    <td class="item-name" th:text="${entry.key}"></td>
                    <td class="item-count" th:text="${entry.value}" style="text-align: right; color: #03e9f4;"></td>
                </tr>
            </table>
        </div>
    </div>

    <style>
        .laberge-summary {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background: rgba(255, 255, 255, 0.05);
            border-radius: 8px; margin-bottom: 8px; border: 1px solid rgba(3, 233, 244, 0.1);
            cursor: pointer; transition: all 0.3s ease; color: white; font-weight: 500;
        }
        .laberge-summary:hover {
            background: rgba(3, 233, 244, 0.1); border-color: rgba(3, 233, 244, 0.5);
        }
        .laberge-badge {
            background: #03e9f4; color: #1c2a3f;
            padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em;
        }
        .laberge-details {
            display: none; padding: 10px 15px; margin-bottom: 15px;
            border-left: 2px solid #03e9f4; background: rgba(0, 0, 0, 0.2); border-radius: 0 8px 8px 0;
        }
        .laberge-details table { width: 100%; color: #cbd5e0; font-size: 0.95em; }
        .laberge-details td { padding: 4px 0; }
        .laberge-count { text-align: right; color: #03e9f4; font-weight: bold; }
    </style>
    <script>
        function toggleGaveta(idGaveta) {
            var gaveta = document.getElementById(idGaveta);
            if (gaveta.style.display === "none" || gaveta.style.display === "") {
                gaveta.style.display = "block";
            } else {
                gaveta.style.display = "none";
            }
        }
    </script>

    <h3 style="color: #03e9f4; margin-bottom: 20px; border-left: 4px solid #03e9f4; padding-left: 10px; margin-top: 40px;">üî¨ Sistema LaBerge (Avan√ßado)</h3>
    <div class="analysis-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
        
        <div class="analysis-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="color: white; font-size: 1.2em; margin-bottom: 20px;">üß† 1. Consci√™ncia Interna</h3>
            
            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-pens')">
                    <span>üí≠ Pensamentos</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cPensamentos.values()) ?: 0}">0</span>
                </div>
                <div id="gav-pens" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cPensamentos}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-emoc')">
                    <span>‚ù§Ô∏è Emo√ß√µes</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cEmocoes.values()) ?: 0}">0</span>
                </div>
                <div id="gav-emoc" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cEmocoes}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-sens')">
                    <span>üå¨Ô∏è Sensa√ß√µes</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cSensacoes.values()) ?: 0}">0</span>
                </div>
                <div id="gav-sens" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cSensacoes}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-perc')">
                    <span>üëÅÔ∏è Percep√ß√µes</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cPercepcoes.values()) ?: 0}">0</span>
                </div>
                <div id="gav-perc" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cPercepcoes}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="analysis-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="color: white; font-size: 1.2em; margin-bottom: 20px;">üèÉ 2. A√ß√£o</h3>
            
            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-acao-ego')">
                    <span>üôã Minha A√ß√£o</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cAcaoEgo.values()) ?: 0}">0</span>
                </div>
                <div id="gav-acao-ego" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cAcaoEgo}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-acao-pers')">
                    <span>üë• Outros (Personagens)</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cAcaoPers.values()) ?: 0}">0</span>
                </div>
                <div id="gav-acao-pers" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cAcaoPers}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-acao-obj')">
                    <span>‚ú® Objetos</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cAcaoObj.values()) ?: 0}">0</span>
                </div>
                <div id="gav-acao-obj" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cAcaoObj}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="analysis-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="color: white; font-size: 1.2em; margin-bottom: 20px;">üé≠ 3. Forma</h3>
            
            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-forma-ego')">
                    <span>üßç Minha Forma</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cFormaEgo.values()) ?: 0}">0</span>
                </div>
                <div id="gav-forma-ego" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cFormaEgo}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-forma-pers')">
                    <span>üëΩ Personagem</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cFormaPers.values()) ?: 0}">0</span>
                </div>
                <div id="gav-forma-pers" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cFormaPers}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-forma-obj')">
                    <span>üì¶ Objeto</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cFormaObj.values()) ?: 0}">0</span>
                </div>
                <div id="gav-forma-obj" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cFormaObj}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-forma-cen')">
                    <span>üñºÔ∏è Cen√°rio</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cFormaCen.values()) ?: 0}">0</span>
                </div>
                <div id="gav-forma-cen" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cFormaCen}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="analysis-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="color: white; font-size: 1.2em; margin-bottom: 20px;">üåç 4. Contexto</h3>
            
            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-papel')">
                    <span>üé¨ Meu Papel</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cPapelEgo.values()) ?: 0}">0</span>
                </div>
                <div id="gav-papel" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cPapelEgo}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-lugar')">
                    <span>üìç Lugar</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cLugarCen.values()) ?: 0}">0</span>
                </div>
                <div id="gav-lugar" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cLugarCen}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-tempo')">
                    <span>‚è≥ Tempo</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cTempoCen.values()) ?: 0}">0</span>
                </div>
                <div id="gav-tempo" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cTempoCen}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <div class="laberge-summary" onclick="toggleGaveta('gav-situacao')">
                    <span>üåÄ Situa√ß√£o Bizarra</span>
                    <span class="laberge-badge" th:text="${#aggregates.sum(cSituacao.values()) ?: 0}">0</span>
                </div>
                <div id="gav-situacao" class="laberge-details">
                    <table>
                        <tr th:each="entry : ${cSituacao}">
                            <td th:text="${entry.key}"></td><td class="laberge-count" th:text="${entry.value}"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div> </div>
    
    <script>
    // 1. EXECU√á√ÉO AO CARREGAR A P√ÅGINA
    // Garante que apenas a aba 'inicio' apare√ßa ao abrir a Home
    window.onload = function() {
    // Verifica se existe o par√¢metro "aba" na URL (ex: ?aba=historico)
    const urlParams = new URLSearchParams(window.location.search);
    const abaParaAbrir = urlParams.get('aba');

    if (abaParaAbrir) {
        // Se houver o par√¢metro, abre a aba solicitada
        openTab(null, abaParaAbrir);
    } else {
        // Caso contr√°rio, abre o in√≠cio por padr√£o
        const btnInicio = document.querySelector(".tab-btn[onclick*='inicio']");
        if (btnInicio) btnInicio.click();
    }
};

    // 2. L√ìGICA DE NAVEGA√á√ÉO ENTRE ABAS
    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        
        // Esconde todos os conte√∫dos
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { 
            tabcontent[i].classList.remove("show"); 
            tabcontent[i].style.display = "none"; 
        }
        
        // Remove a classe 'active' de todos os bot√µes
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) { 
            tablinks[i].classList.remove("active"); 
        }
        
        // Mostra a aba atual
        const currentTab = document.getElementById(tabName);
        if (currentTab) {
            currentTab.classList.add("show");
            currentTab.style.display = "block";
        }

        // Destaca o bot√£o correto
        if (evt && evt.currentTarget) {
            evt.currentTarget.classList.add("active");
        } else {
            // Procura o bot√£o que cont√©m a chamada para esta aba espec√≠fica
            const targetBtn = document.querySelector(`.tab-btn[onclick*='${tabName}']`);
            if (targetBtn) targetBtn.classList.add("active");
        }
    }

    // 3. EDITOR DE TEXTO (RELATO)
    function formatDoc(cmd, value) { 
        document.execCommand(cmd, false, value); 
    }

    // Sincroniza o editor visual com o campo que o Spring Boot vai salvar
    function sincronizarRelato() {
        const editor = document.getElementById('editor');
        const hiddenInput = document.getElementById('relatoInput');
        if (editor && hiddenInput) {
            hiddenInput.value = editor.innerHTML;
        }
    }

    // Chamada obrigat√≥ria antes de enviar o formul√°rio
    function prepareSubmit() {
        sincronizarRelato();
    }

    // 4. FUN√á√ÉO DE EDI√á√ÉO (PREENCHIMENTO AUTOM√ÅTICO)
    function preencherParaEditar(btn) {
        // IDs e T√≠tulo
        document.getElementById('dreamId').value = btn.getAttribute('data-id');
        document.getElementsByName('titulo')[0].value = btn.getAttribute('data-titulo');
        
        // Conte√∫do do Editor
        const conteudoRelato = btn.getAttribute('data-relato');
        document.getElementById('editor').innerHTML = conteudoRelato;
        document.getElementById('relatoInput').value = conteudoRelato;

        // Lucidez
        const lucidez = btn.getAttribute('data-lucidez');
        const radio = document.querySelector(`input[name="lucidez"][value="${lucidez}"]`);
        if(radio) radio.checked = true;

        // Mapeamento dos campos de an√°lise (Stephen LaBerge)
        const campos = [
            'personagens', 'lugares', 'simbolos', 'pensamentos', 'emocoes', 
            'sensacoes', 'percepcoes', 'acaoEgo', 'acaoPersonagem', 'acaoObjeto', 
            'formaEgo', 'formaPersonagem', 'formaObjeto', 'formaCenario', 
            'papelEgo', 'lugarCenario', 'tempoCenario', 'situacaoBizarra'
        ];

        campos.forEach(campo => {
            let input = document.getElementsByName(campo)[0];
            let valor = btn.getAttribute(`data-${campo.toLowerCase()}`);
            if(input) {
                input.value = (valor === 'null' || valor === null) ? '' : valor;
            }
        });

        // Volta para a aba de In√≠cio e sobe a p√°gina
        const btnInicio = document.querySelector('.tab-btn[onclick*="inicio"]');
        if (btnInicio) btnInicio.click();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function confirmarExclusao(event, url) {
        // Impede o link de navegar imediatamente
        event.preventDefault();

        // Exibe a caixa de confirma√ß√£o nativa
        const confirmou = confirm("Tem certeza que deseja excluir este registo on√≠rico? Esta a√ß√£o n√£o pode ser desfeita.");

        if (confirmou) {
            // Se o utilizador aceitar, redireciona para a URL de exclus√£o
            window.location.href = url;
        }
        
        // Se o utilizador cancelar, nada acontece e ele continua na p√°gina
        return false;
    }
    function formatarTexto(comando) {
        document.execCommand(comando, false, null);
        document.getElementById('editor').focus(); 
    }

    function mudarCor(cor, tipoComando) {
        document.execCommand(tipoComando, false, cor);
        document.getElementById('editor').focus();
    }
 // Preenche a data com o dia de hoje caso seja um sonho novo
    document.addEventListener("DOMContentLoaded", function() {
        var dataInput = document.getElementById('dataSonho');
        if (!dataInput.value) {
            var hoje = new Date();
            // Pega o fuso hor√°rio local e formata para YYYY-MM-DD
            var dataFormatada = new Date(hoje.getTime() - (hoje.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            dataInput.value = dataFormatada;
        }
    });
</script>
</body>
</html>